@model List<b2b.Controllers.OrderHistoryViewModel>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Sipariş Geçmişi";
}

<div class="container-fluid">
    <!-- Başlık -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="font-weight-bold py-3 mb-0">
                @if (ViewBag.CustomerName != null)
                {
                    <span>@ViewBag.CustomerName - Sipariş Geçmişi</span>
                }
                else
                {
                    <span>Sipariş Geçmişi</span>
                }
            </h4>
        </div>
        <div>
            @if (ViewBag.CustomerName != null)
            {
                <a href="/Accounting/Accounts" class="btn btn-secondary">
                    <i class="feather icon-arrow-left mr-2"></i> Geri Dön
                </a>
            }


        </div>
    </div>
    
    @if (ViewBag.CustomerId != null)
    {
        <p class="text-muted">Cari No: @ViewBag.CustomerId</p>
    }
    
    <div class="text-muted small mt-0 mb-4 d-block breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
            <li class="breadcrumb-item"><a href="#!">Cari Yönetimi</a></li>
            <li class="breadcrumb-item active"><a href="#!">Sipariş Geçmişi</a></li>
        </ol>
    </div>

    <div class="row">
        <!-- Sipariş Listesi -->
        <div class="col-xl-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Sipariş No</th>
                                    <th>Müşteri</th>
                                    <th>Tarih</th>
                                    <th>Ürün Sayısı</th>
                                    <th>Toplam Tutar</th>
                                    <th>Durum</th>
                                    <th>Açıklama</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    @foreach (var order in Model)
                                    {
                                        <tr>
                                            <td>
                                                <span class="font-weight-semibold">@order.OrderNumber</span>
                                            </td>
                                            <td>
                                                <span class="text-body">@order.CustomerName</span>
                                            </td>
                                            <td>@order.OrderDate.ToString("dd.MM.yyyy")</td>
                                            <td>@order.ItemCount</td>
                                            <td>
                                                <span class="font-weight-semibold">@order.TotalAmount.ToString("N2") ₺</span>
                                            </td>
                                            <td>
                                                @{
                                                    var statusClass = order.Status switch
                                                    {
                                                        "Beklemede" => "badge badge-warning",
                                                        "Onaylandı" => "badge badge-success",
                                                        "Tamamlandı" => "badge badge-info",
                                                        "İptal" => "badge badge-danger",
                                                        _ => "badge badge-secondary"
                                                    };
                                                }
                                                <span class="@statusClass">@order.Status</span>
                                            </td>
                                            <td>@(string.IsNullOrEmpty(order.Description) ? "-" : order.Description)</td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <!-- Sipariş Detayları -->
                                                    <button type="button" class="btn btn-sm btn-outline-primary" disabled
                                                            title="Sipariş Detayları (İleride Eklenecek)">
                                                        <i class="feather icon-eye"></i>
                                                    </button>
                                                    
                                                    <!-- Durum Güncelleme -->
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle" 
                                                                data-toggle="dropdown" title="Durum Güncelle">
                                                            <i class="feather icon-edit-3"></i>
                                                        </button>
                                                        <div class="dropdown-menu">
                                                            <a class="dropdown-item" href="javascript:void(0)" 
                                                               onclick="updateOrderStatus('@order.OrderNumber', 'Beklemede')">
                                                                <i class="feather icon-clock text-warning"></i> Beklemede
                                                            </a>
                                                            <a class="dropdown-item" href="javascript:void(0)" 
                                                               onclick="updateOrderStatus('@order.OrderNumber', 'Onaylandı')">
                                                                <i class="feather icon-check text-success"></i> Onaylandı
                                                            </a>
                                                            <a class="dropdown-item" href="javascript:void(0)" 
                                                               onclick="updateOrderStatus('@order.OrderNumber', 'Tamamlandı')">
                                                                <i class="feather icon-check-circle text-info"></i> Tamamlandı
                                                            </a>
                                                            <div class="dropdown-divider"></div>
                                                            <a class="dropdown-item text-danger" href="javascript:void(0)" 
                                                               onclick="updateOrderStatus('@order.OrderNumber', 'İptal')">
                                                                <i class="feather icon-x-circle"></i> İptal
                                                            </a>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Fatura Oluştur -->
                                                    @if (order.Status == "Onaylandı" || order.Status == "Tamamlandı")
                                                    {
                                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                                onclick="createInvoice('@order.OrderNumber')" 
                                                                title="Fatura Oluştur">
                                                            <i class="feather icon-file-text"></i>
                                                        </button>
                                                    }
                                                    
                                                    <!-- Teslimat Takibi -->
                                                    @if (order.Status == "Onaylandı")
                                                    {
                                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                                onclick="trackDelivery('@order.OrderNumber')" 
                                                                title="Teslimat Takibi">
                                                            <i class="feather icon-truck"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <i class="feather icon-shopping-cart display-4 text-muted"></i>
                                            <h5 class="mt-3 text-muted">Henüz sipariş bulunmuyor</h5>
                                            <p class="text-muted">Henüz hiç sipariş oluşturulmamış.</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>



@section Scripts {
<style>
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background-color: #000;
    opacity: 0.5;
}

.modal {
    z-index: 1050;
}

.modal.show {
    display: block;
}

body.modal-open {
    overflow: hidden;
}

/* Loading spinner */
.spin {
    animation: spin 1s linear infinite;
}

@@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// jQuery yüklendi mi kontrol et




// jQuery yüklenene kadar bekle
if (typeof $ !== 'undefined') {
    $(document).ready(function() {

    
    // Global fonksiyonları tanımla
    window.showAlert = function(message, type) {
        // Önce mevcut toast'ları temizle
        $('.alert').remove();
        
        var alertDiv = $('<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
            '<strong>' + (type === 'success' ? 'Başarılı!' : type === 'danger' ? 'Hata!' : type === 'warning' ? 'Uyarı!' : 'Bilgi!') + '</strong> ' + message +
            '<button type="button" class="close" data-dismiss="alert">' +
            '<span aria-hidden="true">&times;</span></button></div>');
        
        $('.container-fluid').prepend(alertDiv);
        
        // 3 saniye sonra mesajı kaldır
        setTimeout(function() {
            alertDiv.fadeOut();
        }, 3000);
    };
    

    
    window.updateOrderStatus = function(orderNumber, newStatus) {
        // Loading göster
        var button = $(event.target);
        var originalText = button.html();
        button.html('<i class="feather icon-loader spin"></i> Güncelleniyor...');
        button.prop('disabled', true);
        
        // AJAX ile durum güncelle
        fetch('/Accounting/UpdateStatus', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                orderNumber: orderNumber,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result && result.success) {
                // Durumu canlı güncelle (sayfa yenilenmeden)
                var row = button.closest('tr');
                
                if (row.length > 0) {
                    // Durum sütununu bul (6. sütun)
                    var statusCell = row.find('td:nth-child(6)');
                    
                    if (statusCell.length > 0) {
                        // Eski badge'i kaldır
                        statusCell.find('.badge').remove();
                        
                        // Yeni badge ekle
                        var statusClass = window.getStatusClass(newStatus);
                        statusCell.html(`<span class="${statusClass}">${newStatus}</span>`);
                    }
                    
                    // Butonları güncelle
                    window.updateActionButtons(row, newStatus);
                }
                
                // Başarı mesajı kaldırıldı
                
            } else {
                window.showAlert('Hata: ' + (result && result.message || 'Bilinmeyen hata'), 'danger');
            }
        })
        .catch(error => {
            window.showAlert('Bir hata oluştu!', 'danger');
        })
        .finally(() => {
            // Butonu eski haline getir
            button.html(originalText);
            button.prop('disabled', false);
        });
    };
    
    window.updateActionButtons = function(row, newStatus) {
        var actionsCell = row.find('td:nth-child(8)'); // 8. sütun (İşlemler)
        if (actionsCell.length === 0) return;
        
        // Fatura butonu güncelle
        var invoiceBtn = actionsCell.find('button[onclick*="createInvoice"]');
        if (invoiceBtn.length > 0) {
            if (newStatus === 'Onaylandı' || newStatus === 'Tamamlandı') {
                invoiceBtn.show();
            } else {
                invoiceBtn.hide();
            }
        }
        
        // Teslimat takip butonu güncelle
        var deliveryBtn = actionsCell.find('button[onclick*="trackDelivery"]');
        if (deliveryBtn.length > 0) {
            if (newStatus === 'Onaylandı') {
                deliveryBtn.show();
            } else {
                deliveryBtn.hide();
            }
        }
    };
    

    
    // Durum badge class'ını belirle
    window.getStatusClass = function(status) {
        switch(status) {
            case 'Beklemede': return 'badge badge-warning';
            case 'Onaylandı': return 'badge badge-success';
            case 'Tamamlandı': return 'badge badge-info';
            case 'İptal': return 'badge badge-danger';
            default: return 'badge badge-secondary';
        }
    };
    

    

    });
} else {
    console.error('jQuery is not loaded!');
}





// Fatura oluşturma - Şimdilik devre dışı
function createInvoice(orderNumber) {
    alert('Fatura oluşturma özelliği şimdilik devre dışı.');
}

// Teslimat takibi - Şimdilik devre dışı
function trackDelivery(orderNumber) {
    alert('Teslimat takibi özelliği ileride eklenecek.');
}
</script>
}
