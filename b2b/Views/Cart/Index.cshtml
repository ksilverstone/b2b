@model b2b.Models.Cart
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Sepetim";
    ViewBag.ActivePage = "Cart";
}

<div class="container-fluid flex-grow-1 container-p-y">
    <div class="d-flex">
        <div class="flex-grow-1">
            <h4 class="font-weight-bold py-3 mb-0">Sepetim</h4>
        </div>
    </div>
    <div class="text-muted small mt-0 mb-4 d-block breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
            <li class="breadcrumb-item active">Sepetim</li>
        </ol>
    </div>

    <div class="card">
        <div class="card-body">
            @Html.AntiForgeryToken()
            @if (Model.Items != null && Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th class="text-center" style="width:140px;">Miktar</th>
                                <th class="text-right">Birim Fiyat</th>
                                <th class="text-right">Tutar</th>
                                <th class="text-right">İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                decimal total = 0m;
                            }
                            @foreach (var it in Model.Items)
                            {
                                var line = it.UnitPrice * it.Quantity;
                                total += line;
                                <tr data-id="@it.Id">
                                    <td>
                                        <div class="media align-items-center">
                                            <div class="ui-w-40 mr-2">
                                                @if (!string.IsNullOrEmpty(it.Product?.ImageUrl))
                                                {
                                                    <img src="@it.Product.ImageUrl" class="ui-w-40 rounded" style="width:40px;height:40px;object-fit:cover;"/>
                                                }
                                                else
                                                {
                                                    <div class="ui-w-40 rounded bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                        <i class="feather icon-package text-muted"></i>
                                                    </div>
                                                }
                                            </div>
                                            <div class="media-body">
                                                <div class="font-weight-semibold">@it.Product?.Name</div>
                                                <div class="text-muted small">@it.Product?.SKU</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="input-group input-group-sm" style="width: 120px; margin: 0 auto;">
                                            <div class="input-group-prepend">
                                                <button class="btn btn-outline-secondary btn-dec" type="button">-</button>
                                            </div>
                                            <input type="number" class="form-control text-center qty-input" value="@it.Quantity" min="1">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-inc" type="button">+</button>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-right">@it.UnitPrice.ToString("C")</td>
                                    <td class="text-right line-total">@line.ToString("C")</td>
                                    <td class="text-right">
                                        <button class="btn btn-sm btn-danger btn-remove"><i class="feather icon-x"></i></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-right">Genel Toplam:</th>
                                <th class="text-right" id="grandTotal">@total.ToString("C")</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="text-right">
                    <button id="btnCheckout" class="btn btn-primary">Siparişi Tamamla</button>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="feather icon-shopping-cart" style="font-size: 4rem;"></i>
                    <div class="mt-3">Sepetiniz boş</div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
<script>
$(function(){
    function recalc(){
        var total = 0;
        $('tbody tr').each(function(){
            var $tr = $(this);
            var qty = parseInt($tr.find('.qty-input').val()||'0',10);
            var unit = $tr.find('td').eq(2).text();
            var unitVal = parseFloat($tr.find('td').eq(2).text().replace(/[^0-9,.-]/g,'').replace(',', '.')) || 0;
            var line = qty * unitVal;
            total += line;
            $tr.find('.line-total').text(line.toLocaleString('tr-TR',{style:'currency',currency:'TRY'}));
        });
        $('#grandTotal').text(total.toLocaleString('tr-TR',{style:'currency',currency:'TRY'}));
    }

    $('tbody').on('click', '.btn-inc', function(){
        var $i = $(this).closest('tr').find('.qty-input');
        $i.val((parseInt($i.val()||'1',10))+1).trigger('change');
    });
    $('tbody').on('click', '.btn-dec', function(){
        var $i = $(this).closest('tr').find('.qty-input');
        var v = parseInt($i.val()||'1',10); if(v>1){ $i.val(v-1).trigger('change'); }
    });
    $('tbody').on('change', '.qty-input', function(){
        var $tr = $(this).closest('tr');
        var id = $tr.data('id');
        var qty = parseInt($(this).val()||'1',10);
        // Optimistic UI update
        recalc();
        var token = ($('input[name="__RequestVerificationToken"]').first().val())||'';
        fetch('@Url.Action("UpdateItem","Cart")', {
            method: 'POST',
            headers: { 'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8', 'RequestVerificationToken': token, 'X-Requested-With':'XMLHttpRequest' },
            body: new URLSearchParams({ itemId: id, quantity: qty })
        }).then(r=>r.json()).then(function(r){ if(!r || !r.success){
            $('<div class="alert alert-danger alert-dismissible fade show" role="alert">Güncelleme sırasında hata oluştu'+(r&&r.message?': '+r.message:'')+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
              .appendTo('.container-p-y').delay(2500).fadeOut(400, function(){ $(this).remove(); });
        } else { recalc(); } }).catch(function(){
            $('<div class="alert alert-danger alert-dismissible fade show" role="alert">Güncelleme sırasında hata oluştu<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
              .appendTo('.container-p-y').delay(2500).fadeOut(400, function(){ $(this).remove(); });
        });
    });
    $('tbody').on('click', '.btn-remove', function(){
        var $tr = $(this).closest('tr');
        var id = $tr.data('id');
        var token = ($('input[name="__RequestVerificationToken"]').first().val())||'';
        fetch('@Url.Action("RemoveItem","Cart")', {
            method: 'POST',
            headers: { 'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8', 'RequestVerificationToken': token, 'X-Requested-With':'XMLHttpRequest' },
            body: new URLSearchParams({ itemId: id })
        }).then(async function(r){
            // Bazı durumlarda JSON yerine redirect/HTML dönebilir
            var txt = await r.text();
            try { var data = JSON.parse(txt); } catch(e) { data = null; }
            if (data && data.success) {
                $tr.fadeOut(200, function(){
                    $(this).remove();
                    if ($('tbody tr').length === 0) {
                        // Tablo boşaldıysa kart gövdesini boş sepet görünümüne çevir
                        $('.table-responsive').remove();
                        $('tfoot').remove();
                        $('.card-body').append('<div class="text-center text-muted py-5"><i class="feather icon-shopping-cart" style="font-size: 4rem;"></i><div class="mt-3">Sepetiniz boş</div></div>');
                        $('#btnCheckout').prop('disabled', true).addClass('disabled');
                    } else {
                        recalc();
                    }
                });
            } else {
                $('<div class="alert alert-danger alert-dismissible fade show" role="alert">Silme sırasında hata oluştu'+(data&&data.message?': '+data.message:'')+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
                  .appendTo('.container-p-y').delay(2500).fadeOut(400, function(){ $(this).remove(); });
            }
        }).catch(function(){
            $('<div class="alert alert-danger alert-dismissible fade show" role="alert">Silme sırasında hata oluştu<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
              .appendTo('.container-p-y').delay(2500).fadeOut(400, function(){ $(this).remove(); });
        });
    });

    $('#btnCheckout').on('click', function(){
        var token = ($('input[name="__RequestVerificationToken"]').first().val())||'';
        fetch('@Url.Action("Checkout","Cart")', {
            method: 'POST',
            headers: { 'RequestVerificationToken': token, 'X-Requested-With':'XMLHttpRequest' }
        }).then(async function(r){
            var txt = await r.text();
            try { var data = JSON.parse(txt); } catch(e) { data = null; }
            if (data && data.success && data.redirectUrl) {
                window.location.href = data.redirectUrl;
            } else if (r.ok && txt && txt.indexOf('<!DOCTYPE') >= 0) {
                // HTML döndüyse AccessDenied olabilir
                window.location.href = r.url || '@Url.Action("Login","Auth")';
            } else {
                $('<div class="alert alert-danger alert-dismissible fade show" role="alert">İşlem sırasında hata oluştu'+(data&&data.message?': '+data.message:'')+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
                  .appendTo('.container-p-y').delay(2500).fadeOut(400, function(){ $(this).remove(); });
            }
        }).catch(function(){
            $('<div class="alert alert-danger alert-dismissible fade show" role="alert">İşlem sırasında hata oluştu<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>')
              .appendTo('.container-p-y').delay(2500).fadeOut(400, function(){ $(this).remove(); });
        });
    });
});
</script>
}


